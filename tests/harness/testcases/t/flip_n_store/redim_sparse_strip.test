# This is from Ticket #2837.  It tests the behavior of two-dimensional
# array with a sparse data strip

--setup

CREATE ARRAY MSFT_RAW < t : double, price : double, time : int64  > [ i=0:*,1000000,0 ]

# The data in the scidb file was generated by:
#    csv2scidb -s 1 -f 0 -p NN </public/data/bluecrest/MSFT_RAW.csv \
#       > /public/data/bluecrest/MSFT_RAW2.scidb
--igdata "load ( MSFT_RAW, '/public/data/bluecrest/MSFT_RAW2.scidb')"
CREATE ARRAY trades < price : double > [ equity=0:*,100,0, time=0:*,30000000,0 ]
--igdata "redimension_store(apply(MSFT_RAW, equity, 1),trades)"

--test
--start-query-logging

--shell --command "iquery -c ${IQUERY_HOST:=localhost} -p ${IQUERY_PORT:=1239} -o csv+ -aq 'aggregate(trades, count(*), equity)' | head -n 10" --store
--shell --command "iquery -c ${IQUERY_HOST:=localhost} -p ${IQUERY_PORT:=1239} -o csv+ -aq 'filter(trades, equity=1)' | head -n 10" --store
--shell --command "iquery -c ${IQUERY_HOST:=localhost} -p ${IQUERY_PORT:=1239} -o csv+ -aq 'between(trades, null,null,null,null)' | head -10" --store
--shell --command "iquery -c ${IQUERY_HOST:=localhost} -p ${IQUERY_PORT:=1239} -o csv+ -aq 'between(trades, 1,0,null,null)'  | head -10" --store
--shell --command "iquery -c ${IQUERY_HOST:=localhost} -p ${IQUERY_PORT:=1239} -o csv+ -aq 'between(trades, 0,0,null,null)'  | head -10" --store
--shell --command "iquery -c ${IQUERY_HOST:=localhost} -p ${IQUERY_PORT:=1239} -o csv+ -aq 'join(trades,trades)'  | head -n 10" --store

--stop-query-logging
--cleanup

remove(MSFT_RAW)
remove(trades)

