--setup
--start-query-logging

create empty array ABR1 <a:float,b:float>[x=0:3000,3,0]
create empty array ABR2 <a:float>[x=0:3000,3,0]
create empty array ABR3 <b:float>[a(float)=4000,1,0]
store(join(build_sparse(ABR2, x+1.321 ,1),build_sparse(ABR2, x+1.123, 1)),ABR1)

--test 
--echo "issuing redim"

--shell --command "../utils/killquery.sh -afl 2 2 'redimension_store(ABR1, ABR3)' 1> /tmp/${PPID}_1.stdout || echo FAILURE" --store
# log the output
--shell --command "cat /tmp/${PPID}_1.stdout"

--shell --command "../utils/killquery.sh -afl 2 15 'redimension_store(ABR1, ABR3)' 1> /tmp/${PPID}_2.stdout || echo FAILURE" --store
# log the output
--shell --command "cat /tmp/${PPID}_2.stdout"

--shell --command "../utils/killquery.sh -afl 2 9 'redimension_store(ABR1, ABR3)' 1> /tmp/${PPID}_3.stdout || echo FAILURE" --store
# log the output
--shell --command "cat /tmp/${PPID}_3.stdout"

--echo "should be empty..."
count(ABR3)
versions(ABR3)
--error "scan(ABR3:a)"

--echo "should be no mapping arrays..."
project(sort(filter(list('arrays'), regex(name,'ABR.*'))),name,schema)

--cleanup
--stop-query-logging
remove(ABR1)
remove(ABR2)
remove(ABR3)
--shell --command "rm -f /tmp/${PPID}_1.stdout 2>/dev/null"
--shell --command "rm -f /tmp/${PPID}_2.stdout 2>/dev/null"
--shell --command "rm -f /tmp/${PPID}_3.stdout 2>/dev/null"
