--setup
--shell --command "rm -f /dev/shm/SciDB* 2>/dev/null"
load_library('dense_linear_algebra')

--test

# this test assumes the default liveness timeout of 120 sec
# AND that mpi_test() takes less than that
# AND that join(mpi_test(), mpi_test()) takes longer than 120 sec

# start 2 independent, concurrent mpi_test() queries, to show that they will be properly serialized if necessary.
# if interrupted, this shell command will kill the current process group (typically scidbtestharness+children).
# this way the background iquery started here does not stay behind - best effort cleanup attempt.

--shell --command "trap 'kill 0' SIGINT SIGTERM SIGHUP SIGQUIT ; ( iquery -p ${IQUERY_PORT:=1239} -c ${IQUERY_HOST:=localhost} -odcsv -aq 'mpi_test()' 1> /tmp/${PPID}_1.stdout 2> /tmp/${PPID}_1.stderr ) & export pid=$! ; export rc=0 ; iquery -p ${IQUERY_PORT:=1239} -c ${IQUERY_HOST:=localhost} -odcsv -aq 'mpi_test()' 1> /tmp/${PPID}_2.stdout 2> /tmp/${PPID}_2.stderr || export rc=${rc}2 ; wait $pid || export rc=${rc}1 ; echo $rc && [ $rc == 0 ]; " --store

--shell --command "cat /tmp/${PPID}_1.stderr" --store
--shell --command "cat /tmp/${PPID}_1.stdout" --store

--shell --command "cat /tmp/${PPID}_2.stderr" --store
--shell --command "cat /tmp/${PPID}_2.stdout" --store

# start 2 concurrent mpi_test-based queries, but make the first one so long that the second one will time out waiting, in order to test that the timeout function works..
# if interrupted, this shell command will kill the current process group (typically scidbtestharness+children).
# this way the background iquery started here does not stay behind - best effort cleanup attempt.

--shell --command "trap 'kill 0' SIGINT SIGTERM SIGHUP SIGQUIT ; ( iquery -p ${IQUERY_PORT:=1239} -c ${IQUERY_HOST:=localhost} -odcsv -aq 'join(mpi_test(), mpi_test())' 1> /tmp/${PPID}_1.stdout 2> /tmp/${PPID}_1.stderr ) & export pid=$! ; export rc=0 ; iquery -p ${IQUERY_PORT:=1239} -c ${IQUERY_HOST:=localhost} -odcsv -aq 'join(mpi_test(), mpi_test())' 1> /tmp/${PPID}_1.stdout 2> /tmp/${PPID}_2.stderr || export rc=${rc}2 ; wait $pid || export rc=${rc}1 ; [ $rc == 01 ] || [ $rc == 02 ] && echo 0 ;" --store

# compare only the error code
--shell --command "grep scidb::SCIDB_SE_EXECUTION::SCIDB_LE_RESOURCE_BUSY /tmp/${PPID}_1.stderr 2>/dev/null || grep scidb::SCIDB_SE_EXECUTION::SCIDB_LE_RESOURCE_BUSY /tmp/${PPID}_2.stderr 2>/dev/null" --store

# log the output
--shell --command "cat /tmp/${PPID}_1.stderr"
--shell --command "cat /tmp/${PPID}_1.stdout"
--shell --command "cat /tmp/${PPID}_2.stderr"
--shell --command "cat /tmp/${PPID}_2.stdout"

--shell --command "ls /dev/shm/SciDB* 2>/dev/null" --store

--cleanup
--shell --command "rm -f /dev/shm/SciDB* 2>/dev/null"
--shell --command "rm -f /tmp/${PPID}_1.stdout 2>/dev/null"
--shell --command "rm -f /tmp/${PPID}_1.stderr 2>/dev/null"
--shell --command "rm -f /tmp/${PPID}_2.stdout 2>/dev/null"
--shell --command "rm -f /tmp/${PPID}_2.stderr 2>/dev/null"
